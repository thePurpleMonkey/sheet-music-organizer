<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="Michael Humphrey">

    <title>Collections - Sheet Music Organizer</title>
	
	<!-- Scripts -->
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </head>

  <body>
	  <div class="container">
			<!-- Header -->
		  <h1>Collections:</h1>
		  <hr>

			<!-- Alert -->
			<div class="alert alert-success alert-dismissible" role="alert" style="display:none;">
				<strong>Collection created!</strong><br>
				The collection was successfully created.
				<button type="button" class="close" aria-label="Close" id="alert-close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>

			<!-- Collection list -->
		  <ul id="collections">
			  <!-- <li id="loading">Loading collections, please wait...</li> -->
		  </ul>
		  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#new_collection_modal" id="new_collection">New collection</button>
	  </div>

	  <!-- New collection modal -->
	  <div class="modal fade" id="new_collection_modal" tabindex="-1" role="dialog">
			<div class="modal-dialog modal-lg" role="document">
			  <div class="modal-content">
				<div class="modal-header">
				  <h5 class="modal-title" id="exampleModalLabel">New Collection</h5>
				  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				  </button>
				</div>
				<div class="modal-body">
				  <form>
					<div class="form-group">
					  <label for="name" class="col-form-label">Collection name:</label>
					  <input type="text" class="form-control" id="name">
					</div>
					<div class="form-group">
					  <label for="description" class="col-form-label">Collection description:</label>
					  <textarea class="form-control" id="description"></textarea>
					</div>
				  </form>
				</div>
				<div class="modal-footer">
				  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				  <button type="button" class="btn btn-primary" id="create_collection">Create collection</button>
				</div>
			  </div>
			</div>
		</div>

		<!-- Wait modal -->
		<div class="modal fade in" tabindex="-1" role="dialog" id="wait">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Creating collection...</h5>
					</div>
					<div class="modal-body">
						<p>Please wait while we create your collection...</p>
					</div>
					</div>
				</div>
			</div>
		
		<!-- Script -->
		<script>
			function refreshCollections() {
				$("#collections").empty();
				$("#collections").append("<li>Loading collections, please wait...</li>");
				$.get("/collections")
				.done(function(data) {
					console.log(data);
					$("#collections").empty();

					data.forEach(collection => {
						let li = $("<li>");
						let a = $("<a>");
						a.attr("href", "/collection.html?collection_id=" + collection.collection_id);
						a.text(collection.name);
						li.append(a);
						$("#collections").append(li);
					});
				})
				.fail(function(data) {
					alert("Unable to get collections.\n" + data.responseJSON.error);
				})
				.always(function() {
					$("#loading").remove();
				});
			};

			refreshCollections();

			$("#create_collection").click(function() {
				$("#new_collection_modal").modal("hide");
				$('#new_collection_modal').on('hidden.bs.modal', function (e) {
					$("#wait").modal("show");
					$('#wait').on('shown.bs.modal', function (e) {
						let payload = JSON.stringify({name: $("#name").val(), description: $("#description").val()});
						$.post("/collections", payload)
						.done(function(data) {
							console.log(data);
							$(".alert").show();
						})
						.fail(function(data) {
							alert("Unable to create collection.\n" + data.responseJSON.error);
						})
						.always(function() {
							$("#wait").modal("hide");
							refreshCollections();
						});
					});
				});
			});
			
			// Close alert
			$("#alert-close").click(function() {
				$(".alert").hide()
			})
		</script>
  </body>
</html>
